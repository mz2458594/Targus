<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reportes | Targus</title>
    <link rel="icon" th:href="@{/images/logo.png}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/styleventa.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header class="header" th:insert="venta/header.html"></header>
    <nav class="navbar" th:insert="venta/navbar.html"></nav>

    <main class="contenedor_main">
        <div class="contenedor_modal">
            <div class="reporte__ventas">
                <div class="filtros__ventas">
                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="fecha-inicio">Desde:</label>
                            <input type="date" id="fecha-inicio" name="fechaInicio" />
                        </div>
                        <div class="filtro-campo">
                            <label for="fecha-fin">Hasta:</label>
                            <input type="date" id="fecha-fin" name="fechaFinal" />
                        </div>
                    </div>

                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="comprobante">Tipo de comprobante:</label>
                            <select id="comprobante" name="tipo">
                                <option value="" disabled selected>Selecciona</option>
                                <option value="BOLETA">Boleta</option>
                                <option value="FACTURA">Factura</option>
                            </select>
                        </div>
                        <div class="filtro-campo">
                            <label for="nro-inicial">Comprobante inicial:</label>
                            <input type="number" id="nro-inicial" placeholder="Ej: 1001" />
                        </div>
                        <div class="filtro-campo">
                            <label for="nro-final">Comprobante final:</label>
                            <input type="number" id="nro-final" placeholder="Ej: 1050" />
                        </div>
                    </div>

                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="total-transacciones">Total transacciones:</label>
                            <input type="number" id="total-transacciones" readonly value="0" />
                        </div>
                        <div class="filtro-campo">
                            <label for="total-ventas">Total ventas (S/):</label>
                            <input type="number" id="total-ventas" readonly value="0.00" />
                        </div>
                        <div class="filtro-campo"></div>
                    </div>

                    <!-- NUEVO: Responsable y Botón de Buscar -->
                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="responsable">Responsable de la venta:</label>
                            <select id="responsable" name="idResponsable">
                                <option value="" disabled selected>Selecciona</option>
                                <option th:each="empleado : ${empleados}" th:value="${empleado.id}"
                                    th:text="${empleado.nombre}">Juan Pérez</option>
                            </select>
                        </div>
                        <div class="filtro-campo">
                            <label>&nbsp;</label>
                            <button id="btn-buscar" class="btn-buscar" onclick="buscarVentas()">
                                <i class="fa-solid fa-magnifying-glass"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cont-reportes">
                <p>Generar reporte:</p>
                <div class="reporte-btns">
                    <button class="btn-pdf"><i class="fa-solid fa-file-pdf"></i></button>
                    <button class="btn-excel"><i class="fa-solid fa-file-excel"></i></button>
                </div>
            </div>
        </div>

        <div class="cont_table">
            <div class="table__product">
                <table class="table">
                    <thead>
                        <tr class="thead">
                            <th>N Comprobante</th>
                            <th>Fecha Venta</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Boleta/Factura</th>
                            <th>Nombre Cliente</th>
                            <th>Contacto</th>
                        </tr>
                    </thead>
                    <!-- Ejemplo de ventas -->
                    <tbody id="tablaProductos">
                        <tr>
                            <td>101</td>
                            <td>16/06/2025</td>
                            <td>Laptop Asus</td>
                            <td>i5,500gb Ssd, 8gb, Modelo Zx-4500</td>
                            <td>2</td>
                            <td>1469</td>
                            <td>5%</td>
                            <td>Boleta</td>
                            <td>Adrian Torres</td>
                            <td>example@gmail.com</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container" id="dashboard">
            <div class="chart-block">
                <h2>Métodos de Pago</h2>
                <canvas id="paymentChart"></canvas>
            </div>
            <div class="chart-block">
                <h2>Productos Más Vendidos</h2>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Datos ocultos para graficos -->
        <input hidden type="number" id="product-1" value="12">
        <input hidden type="number" id="product-2" value="30">
        <input hidden type="number" id="product-3" value="34">
        <input hidden type="number" id="product-4" value="35">
        <input hidden type="number" id="product-5" value="50">

        <input hidden type="number" id="pago-efectivo" value="150">
        <input hidden type="number" id="pago-yape" value="80">
        <input hidden type="number" id="pago-plin" value="50">
        <input hidden type="number" id="pago-tarjeta" value="120">
    </main>

    <!-- Script para capturar filtros -->
    <script>

        const tabla = document.getElementById('tablaProductos')

        function buscarVentas() {
            const fechaInicio = document.getElementById("fecha-inicio").value;
            const fechaFinal = document.getElementById("fecha-fin").value;
            const comprobante = document.getElementById("comprobante").value;
            const nroInicial = document.getElementById("nro-inicial").value;
            const nroFinal = document.getElementById("nro-final").value;
            const idResponsable = document.getElementById("responsable").value;

            console.log("Buscando ventas con:");
            console.log("Desde:", fechaInicio, "Hasta:", fechaFinal);
            console.log("Comprobante:", comprobante, "N° Inicial:", nroInicial, "N° Final:", nroFinal);
            console.log("Responsable:", idResponsable);

            const datos = { fechaInicio: fechaInicio, fechaFinal: fechaFinal, comprobante: comprobante, idResponsable, idResponsable }

            fetch(`http://localhost:8080/api/sale/filtro`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error el obtener el detalle del producto")
                    }
                    return response.json();
                })
                .then(detalle => {
                    let html = ''
                    detalle.forEach(element => {
                        html += `
                        <tr>
                            <td>101</td>
                            <td>${element.fechaVenta}</td>
                            <td>${element.ventaProductos.producto.nombre}</td>
                            <td>${element.ventaProductos.cantidad}</td>
                            <td>${element.ventaProductos.producto.precioVenta}</td>
                            <td>${element.comprobante.tipo}</td>
                            <td>${element.usuario.username}</td>
                            <td>${element.usuario.email}</td>
                        </tr>
                    `
                    });

                    tabla.innerHTML = html
                })
                .catch(error => {
                    console.error("Error ", error)
                })


        }

        window.onload = function () {
            // Charts
            const productos = ["Logitech", "ROG Strix", "Teclado Genius", "Xiaomi", "Redmi Buds 5"];
            const ventas = [
                Number(document.getElementById('product-1').value),
                Number(document.getElementById('product-2').value),
                Number(document.getElementById('product-3').value),
                Number(document.getElementById('product-4').value),
                Number(document.getElementById('product-5').value)
            ];
            const ctxProductos = document.getElementById('barChart').getContext('2d');
            new Chart(ctxProductos, {
                type: 'pie',
                data: {
                    labels: productos,
                    datasets: [{
                        data: ventas,
                        backgroundColor: ['#4bc0c0', '#36a2eb', '#ffce56', '#9966ff', '#ff6384'],
                        borderWidth: 1
                    }]
                }
            });

            const metodosPago = ["Efectivo", "Yape", "Plin", "Tarjeta"];
            const pagos = [
                Number(document.getElementById('pago-efectivo').value),
                Number(document.getElementById('pago-yape').value),
                Number(document.getElementById('pago-plin').value),
                Number(document.getElementById('pago-tarjeta').value)
            ];
            const ctxPagos = document.getElementById('paymentChart').getContext('2d');
            new Chart(ctxPagos, {
                type: 'pie',
                data: {
                    labels: metodosPago,
                    datasets: [{
                        data: pagos,
                        backgroundColor: ['#ff9f40', '#9966ff', '#36a2eb', '#ff6384'],
                        borderWidth: 1
                    }]
                }
            });
        };
    </script>

    <script th:src="@{/js/modalAdd.js}"></script>
    <script th:src="@{/js/general.js}"></script>
</body>

</html>