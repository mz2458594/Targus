<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reportes | Targus</title>
    <link rel="icon" th:href="@{/images/logo.png}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/styleventa.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <header class="header" th:insert="venta/header.html"></header>
    <nav class="navbar" th:insert="venta/navbar.html"></nav>
    <main class="contenedor_main">
        <div class="contenedor_modal">
            <div class="reporte__ventas">
                <div class="filtros__ventas">
                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="fecha-inicio">Desde:</label>
                            <input type="date" id="fecha-inicio" name="fechaInicio" />
                        </div>
                        <div class="filtro-campo">
                            <label for="fecha-fin">Hasta:</label>
                            <input type="date" id="fecha-fin" name="fechaFinal" />
                        </div>
                    </div>
                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="comprobante">Tipo de comprobante:</label>
                            <select id="comprobante" name="tipo">
                                <option value="" disabled selected>Selecciona</option>
                                <option value="BOLETA">Boleta</option>
                                <option value="FACTURA">Factura</option>
                            </select>
                        </div>
                        <div class="filtro-campo">
                            <label for="nro-inicial">Comprobante inicial:</label>
                            <input type="number" id="nro-inicial" placeholder="Ej: 1001" />
                        </div>
                        <div class="filtro-campo">
                            <label for="nro-final">Comprobante final:</label>
                            <input type="number" id="nro-final" placeholder="Ej: 1050" />
                        </div>
                    </div>
                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="total-transacciones">Total transacciones:</label>
                            <input type="number" id="total-transacciones" readonly value="0" />
                        </div>
                        <div class="filtro-campo">
                            <label for="total-ventas">Total ventas (S/):</label>
                            <input type="number" id="total-ventas" readonly value="0.00" />
                        </div>
                        <div class="filtro-campo"></div>
                    </div>
                    <div class="filtro-fila">
                        <div class="filtro-campo">
                            <label for="responsable">Responsable de la venta:</label>
                            <select id="responsable" name="idResponsable">
                                <option value="" disabled selected>Selecciona</option>
                                <option th:each="empleado : ${empleados}" th:value="${empleado.id}"
                                    th:text="${empleado.nombre}">Carlos</option>
                            </select>
                        </div>
                        <div class="filtro-campo">
                            <label>&nbsp;</label>
                            <button id="btn-buscar" class="btn-buscar" onclick="buscarVentas()">
                                <i class="fa-solid fa-magnifying-glass"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="cont-reportes">
                <p>Generar reporte:</p>
                <div class="reporte-btns">
                    <button class="btn-pdf"><i class="fa-solid fa-file-pdf"></i></button>
                    <button class="btn-excel"><i class="fa-solid fa-file-excel"></i></button>
                </div>
            </div>
        </div>
        <div class="cont_table">
            <div class="table__product">
                <table class="table" id="tablaCompleta">
                    <thead>
                        <tr class="thead">
                            <th>N Comprobante</th>
                            <th>Fecha Venta</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Boleta/Factura</th>
                            <th>Responsable</th>
                            <th>Contacto</th>
                        </tr>
                    </thead>
                    <!-- Ejemplo de ventas -->
                    <tbody id="tablaProductos">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container" id="dashboard">
            <div class="chart-block">
                <h2 style="display: none;">Productos Más Vendidos</h2>
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        const tabla = document.getElementById('tablaProductos')
        let chartProductos = null
        function buscarVentas() {
            const fechaInicio = document.getElementById("fecha-inicio").value;
            const fechaFinal = document.getElementById("fecha-fin").value;
            const comprobante = document.getElementById("comprobante").value;
            const nroInicial = document.getElementById("nro-inicial").value;
            const nroFinal = document.getElementById("nro-final").value;
            const idResponsable = document.getElementById("responsable").value;
            console.log("Buscando ventas con:");
            console.log("Desde:", fechaInicio, "Hasta:", fechaFinal);
            console.log("Comprobante:", comprobante, "N° Inicial:", nroInicial, "N° Final:", nroFinal);
            console.log("Responsable:", idResponsable);
            const datos = { fechaInicio: fechaInicio, fechaFinal: fechaFinal, comprobante: comprobante, idResponsable, idResponsable }
            fetch(`http://localhost:8080/api/sale/filtro`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error el obtener el detalle del producto")
                    }
                    return response.json();
                })
                .then(detalle => {
                    let html = ''
                    if (detalle.length > 0) {
                        detalle.forEach(element => {
                            element.ventaProductos.forEach(detalle => {
                                html += `
                        <tr>
                            <td>${element.comprobante.numero}</td>
                            <td>${element.fechaVenta}</td>
                            <td class="productName">${detalle.producto.nombre}</td>
                            <td class="productQuantity">${detalle.cantidad}</td>
                            <td>${detalle.producto.precioVenta}</td>
                            <td>${element.comprobante.tipo}</td>
                            <td>${element.usuario.username}</td>
                            <td>${element.usuario.email}</td>
                        </tr>
                    `
                            })
                        });
                        tabla.innerHTML = html
                        const conteoProductos = {}
                        const nombres = document.querySelectorAll('.productName')
                        const cantidades = document.querySelectorAll('.productQuantity')

                        nombres.forEach((element, index) => {
                            const nombre = element.textContent.trim()
                            const cantidad = parseInt(cantidades[index].textContent.trim())
                            conteoProductos[nombre] = (conteoProductos[nombre] || 0) + cantidad
                        })
                        const labels = Object.keys(conteoProductos)
                        const data = Object.values(conteoProductos)
                        const ctxProductos = document.getElementById('barChart').getContext('2d');
                        document.querySelector('#dashboard .chart-block').style.display = "block";
                        document.querySelector('#dashboard h2').style.display = "block"
                        if (chartProductos) {
                            chartProductos.destroy()
                        }
                        chartProductos = new Chart(ctxProductos, {
                            type: 'pie',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: ['#4bc0c0', '#36a2eb', '#ffce56', '#9966ff', '#ff6384'],
                                    borderWidth: 1
                                }]
                            }
                        });
                    } else {
                        html = `<tr><td colspan="8" style="text-align:center;">No hay resultados</td></tr>`
                        document.querySelector('#dashboard .chart-block').style.display = "none"
                        tabla.innerHTML = html
                    }
                })
                .catch(error => {
                    console.error("Error ", error)
                })
        }

    </script>
    <script>function obtenerNombreResponsable() {
            const select = document.getElementById('responsable');
            const selected = select.options[select.selectedIndex];
            return selected ? selected.text : 'No especificado';
        }

        document.querySelector(".btn-pdf").addEventListener("click", () => {
            const now = new Date().toLocaleString();
            const responsable = obtenerNombreResponsable();

            const tablaCompleta = document.getElementById("tablaCompleta").outerHTML;

            const filas = document.querySelectorAll('#tablaProductos tr');
            const totalVentasCount = filas.length;

            let totalIngresos = 0;
            filas.forEach(fila => {
                const cantidad = parseFloat(fila.cells[3]?.textContent) || 0;
                const precio = parseFloat(fila.cells[4]?.textContent) || 0;
                totalIngresos += cantidad * precio;
            });

            const nroPrimeraVenta = filas.length > 0 ? filas[0].cells[0].textContent : 'N/A';
            const nroUltimaVenta = filas.length > 0 ? filas[filas.length - 1].cells[0].textContent : 'N/A';

            const totalVentas = document.getElementById("total-ventas").value;
            const totalTransacciones = document.getElementById("total-transacciones").value;

            const contenido = `
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 11px;
                table-layout: fixed;
                word-wrap: break-word;
            }
            th, td {
                border: 1px solid #000;
                padding: 4px;
                max-width: 100px;
                text-align: left;
            }
            thead {
                background-color: #ddd;
                display: table-header-group;
            }
            tr {
                page-break-inside: avoid;
            }
            .header-container {
                text-align: center;
                margin-bottom: 10px;
            }
            .header-container img {
                max-height: 60px;
                margin-bottom: 10px;
            }
            .info-table {
                margin: 10px 0;
                width: 100%;
                font-size: 11px;
                border-collapse: collapse;
            }
            .info-table th, .info-table td {
                border: 1px solid #000;
                padding: 4px 8px;
                background-color: #f0f0f0;
            }
            .totales-table {
                width: 40%;
                margin-top: 10px;
                font-size: 11px;
                border-collapse: collapse;
            }
            .totales-table th, .totales-table td {
                border: 1px solid #000;
                padding: 6px;
                text-align: left;
            }
        </style>
        <div class="header-container">
            <img src="/images/logo.png" alt="Logo Empresa" />
            <h2>REPORTE DE VENTAS</h2>
            <p>Fecha de creación: ${now}</p>
            <p>Responsable: ${responsable}</p>
        </div>
        <table class="info-table">
            <tr>
                <td><strong>Primera Venta:</strong> ${nroPrimeraVenta}</td>
                <td><strong>Última Venta:</strong> ${nroUltimaVenta}</td>
            </tr>
            <tr>
                <td><strong>N° Ventas:</strong> ${totalVentasCount}</td>
                <td><strong>Total Ingresos (S/):</strong> ${totalIngresos.toFixed(2)}</td>
            </tr>
        </table>

        ${tablaCompleta}

        <table class="totales-table">
            <tr>
                <th>Total Transacciones</th>
                <td>${totalTransacciones}</td>
            </tr>
            <tr>
                <th>Total Ventas (S/)</th>
                <td>${parseFloat(totalVentas).toFixed(2)}</td>
            </tr>
        </table>
    `;

            const div = document.createElement("div");
            div.innerHTML = contenido;
            div.style.display = "block";
            document.body.appendChild(div);

            const opt = {
                margin: 0.5,
                filename: 'reporte_ventas.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { letterRendering: true, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(div).save().then(() => {
                    document.body.removeChild(div);
                });
            }, 200);
        });

    </script>

</body>

<script>
    window.addEventListener("load", buscarVentas);
</script>

</html>